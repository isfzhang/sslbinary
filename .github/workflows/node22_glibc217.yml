name: Build Node22.20.0 ARM64 Low GLIBC

on:
  workflow_dispatch:

jobs:
  build-node22:
    runs-on: ubuntu-latest
    name: Build Node.js 22.20.0 for ARM64 glibc 2.17

    steps:
      - uses: actions/checkout@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Node.js inside ARM64 CentOS7 container
        run: |
          docker run --rm -v ${{ github.workspace }}/output:/output --platform linux/arm64 centos:7 bash -c "
            yum groupinstall -y 'Development Tools'
            yum install -y python2 git wget tar xz openssl-devel

            # Clone Node 22.20.0 source
            git clone https://github.com/nodejs/node.git
            cd node
            git checkout v22.20.0

            # Configure and compile Node.js
            ./configure --prefix=/node22
            make -j\$(nproc)
            make install

            # Package the compiled Node
            tar -czvf /output/node22.20.0-arm64-glibc217.tar.gz /node22
          "

      - name: Show output
        run: ls -lh output/
