name: Build Node22.20.0 ARM64 glibc 2.17

on:
  workflow_dispatch:

jobs:
  build-node22:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 安装 QEMU 以支持 ARM64 容器
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      # 安装 Buildx
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Node.js inside ARM64 CentOS7 container
        run: |
          mkdir -p output
          docker run --rm --platform linux/arm64 -v ${{ github.workspace }}/output:/output centos:7 bash -c "
            yum groupinstall -y 'Development Tools'
            yum install -y python2 git wget tar xz openssl-devel

            # Clone Node 22.20.0
            git clone https://github.com/nodejs/node.git
            cd node
            git checkout v22.20.0

            # Compile Node
            ./configure --prefix=/node22
            make -j\$(nproc)
            make install

            # Package the compiled Node
            tar -czvf /output/node22.20.0-arm64-glibc217.tar.gz /node22
          "

      - name: List output
        run: ls -lh output/

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: node22.20.0-arm64-glibc217
          path: output/node22.20.0-arm64-glibc217.tar.gz
